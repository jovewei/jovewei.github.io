---

layout: post
title: 以太坊 Merge(1)：探索升级背后的奥秘与进程
subtitle: 以太坊主网 Merge 预计于9 月15 日或16 日启动
date:   2022-08-27 16:08:00 +0800
author: "Bryce"
header-img:  'images/gallery/moonrise-over-the-sea-caspar-david-friedrich.jpg'
tags:   [区块链, ETH]
---

> <cite>Title: Moonrise over the Sea  
Creator: Caspar David Friedrich  
Date Created: 1822  
Physical Dimensions: w71.0 x h55.0 cm  
Type: Painting  
Technique and material: Oil on canvas  
Artist Place of Death: Dresden, Germany  
Artist Place of Birth: Greifswald, Germany  
Artist Dates: 1774-09-05/1840-05-07  
</cite>  

## 前言

2013年以太坊的出现，让区块链与智能合约以及各类生态应用得到快速发展，在这之后，Web3应用才有了生存发展的土壤。

最新消息显示，以太坊核心开发者在电话会议中暂定了主网TTD，主网“Merge”预计于9 月15 日或16 日启动。那么，轰动web3.0的以太坊“Merge”到底是什么？为什么会有“Merge”？目前“Merge”处于什么状态？

本文将从**以太坊为什么要升级、以太坊升级路线、“Merge”过程中两次重要的升级节点、“Merge”当前进展和难度炸弹**等维度为大家一一解惑，后续文章将继续为大家介绍以太坊Merge后对生态中各个利益相关者的影响，以及后续升级相关的讨论。

## 以太坊为什么要升级？

### 能源消耗问题

自成立以来，以太坊一直致力于实行权益证明共识机制（PoS），但如果要在保证安全性和去中心化的情况下做到这一点，需要多年的重点研究和开发。因此，以太坊目前仍采用工作量证明共识（PoW）。工作量证明要求矿工通过使用他们的计算硬件解决难题实现共识，这对算力消耗极大，同时需要消耗大量的电力成本和硬件成本。

**而随着ETH生态的逐渐扩大，需要处理的交易也越来越多，导致了更多的能源消耗。**

据Digiconomist数据显示，以太坊当前的总能耗约为 112 TWh/年，与荷兰相当，碳排放量相当于新加坡的碳排放量（53 MT/年)。相比之下，比特币目前的能源消耗约为 200 TWh/年，碳排放量约为 100 MT/年，同时每年废弃的硬件大约产生 32,000 吨电器废弃物。

**关闭以太坊的工作量证明，转而采用权益证明将减少超过 99.95% 的能源消耗，这意味着保证以太坊的总能源消耗更接近 0.01 TWh/年。**

![](/images/posts/blockchain/eth_upgrade_1.png)
各个行业的年能源消耗（源自ethereum.org）

### 可扩展性问题（低TPS + 高Gas）

以太坊作为市值第二大的加密货币， **许多项目都在其上开发，需求量大导致网络拥堵。** 根据 Ycharts 网站的资料显示，目前使用 PoW
算法的以太坊，高峰时期需要 16s 才能打包一个区块。每一个区块里会包含 150~300 笔交易，即1秒钟只能处理 10 ~ 20 笔交易。

这样的处理速度导致大面积的网络拥堵经常发生，如果你想要更快的达成交易，那就得多交一些手续费，也就是我们常说的 Gas 费。

![](/images/posts/blockchain/eth_upgrade_2.png)
以太坊平均阻塞时间（源自ycharts.com）

在以太坊链上的每一笔交易都需要支付手续费（Gas Fee），在工作量证明机制（PoW）下矿工会优先处理高价交易，导致当以太坊需求量大增时，价格就会跟着上涨。

以太坊自17年开始有应用到20年前，Gas 费虽然也有波动，但几乎维持在1美元以下，但该值在18年6月出现高点，峰值为5.58美元；20年下半年随着DeFi应用的逐渐增加，大量交易涌入，手续费开始上涨且有巨大波动；21年以来，手续费进入了飙升的白热化，平均手续费在21年5月14日甚至达到了68.74美元，这意味着当天以太坊上平均一笔交易需要额外花费68.74美元的手续费。

**有时候Gas 费的价格甚至还会高于交易本身的金额。这让以太坊用户体验变得很差，也对整个生态的长期发展造成了严重的阻碍。**

### 安全性问题

对于采用POW 工作量证明机制的以太坊来说，矿池的存在使得以太坊的算力呈中心化趋势，且这种情况对以太坊的整体网络安全也产生了威胁。POW
机制下攻击的成本体现在设备以及算力的堆积上，**如果一个人或者集体掌握了系统中51%以上的算力就可以对以太坊发动“51%攻击”，且协议本身无法对这种情况起到有效的抑制效果。**

但是在权益证明系统中，需要验证者们提前质押大量的以太到协议中。如果验证者们尝试攻击网络，协议将通过自动销毁其质押的以太这种惩罚机制保护系统安全。但该方式无法针对工作量证明机制起到有效的防护作用，因为PoW最多没收网络安全保护者（矿工）的挖矿所得。但是如果要实现相同的惩罚效果，协议需要拥有能够摧毁作弊矿工所有挖矿硬件的能力。

### 公链竞争现状

在过去，公链以代替 ETH 为目标，而现在的公链目标更有延伸性，它们以兼容 EVM 为特点，属于以太坊相联公链一类，这类公链指的是无论在执行环境还是应用设计上，都与以太坊极为相似的公链或者说是模仿的公链。

大量的用户流量导入以及资金不留余力地支持，让这些公链能够快速地成长，但最本质的还是因为由于现行以太坊生态的兑换效率低下，网络拥堵使得手续费非常高昂，从而使得普通用户难以持续通过以太坊进行日常交互，造成了用户和资金的外溢，给具有相似功能和应用的相似公链提供了一个绝佳的崛起发展机会。

这都进一步的“提醒”以太坊需要尽快的进行升级，以解决网络拥堵问题，提高效率，降低其成交费用，这样才能够坐稳它的“王位”。

## 以太坊升级路线

ETH升级路线长期来看主要分为5步，分别为：

### Merge

当前以太坊主网将与信标链权益证明系统“合并”，这将标志着以太坊工作量证明机制的淘汰以及向权益证明的完全过渡，预计2022年第三到第四季度完成。

Merge阶段完成后，能源消耗问题会得到完美的解决，安全性也会得到大幅提升。

### Surge

致力于解决以太坊交通拥堵与gas高昂的问题。以太坊将被切割成64个分片，结合Layer2的rollups技术，理论上tps的上限可能是10万笔/秒（当前以太坊tps约为13笔/秒）。

根据以太坊基金会的预估，分片链应该会在2023年的某个时间上线，具体取决于合并后的工作进度，这些分片将增强以太坊存储和访问数据的能力，但不会用于执行代码。

### Verge

技术更新，计划从merkle树过渡到verkle树，可以将它们视为以太坊的数据库，这阶段由于区块数据增大，会反过来验证拓展性和分散网络。这将优化以太坊上的存储并帮助减小节点大小。最终，这有助于
ETH 变得更具可扩展性。

### Purge

清除，意味着并非所有节点都必须永久存储所有历史块。相反，客户端将停止存储超过一年的历史记录。这意味着以太坊对节点的硬件要求会降低，网络的带宽也会降低。

### Splurge

杂项升级，简化以太坊的使用，使其更容易被普通用户访问。

![](/images/posts/blockchain/eth_upgrade_3.png)
以太坊升级路线图，源自vitalik推特

## The Merge

2013年，Vitalik Buterin和Gavin
Wood发布白皮书，构想了“下一代智能合约和去中心化应用平台”——以太坊。自2015年采用工作量证明共识算法以来，以太坊就一直在寻找更好的算法，以打造成一个去中心化、可扩展、安全和节能环保的网络。

2017年，以太坊确定了一种混合PoW/PoS的系统——Casper the Friendly Finality Gadget。Vitalik
Buterin当时提议，要在2019年从PoW转向PoS。

而本次以太坊升级将分为三步进行： **信标链（The Beacon Chain）、合并（The Merge)、分片链(Shard Chains)。**
目前处于合并前夕。

在介绍合并之前，我们先介绍一下以太坊已升级过程中的两个重要节点。

### Beacon Chian（信标链）

**PoS**

权益证明是一种共识算法，要求矿工将其部分代币质押以验证交易。矿工被随机选择来验证一个区块，但那些持有更多股份或持有更长时间的人拥有优势。选择的矿工必须都同意验证交易。

在他们验证了一个块后，它会被添加到链中，并以加密货币的形式收取费用。如果他们没有正确验证，他们自己的股份将受到影响，他们将失去部分代币。这为该过程提供了更多的安全性。其相对于PoW有以下优势：

1.快速处理交易

2.与PoW相反，对环境无害

3.能耗极低，不需要消耗大量电力

4.安全性更高

**质押验证者**

验证者是虚拟的，通过质押者激活而来。在工作量证明的场景里，用户通过购买矿机来成为矿工。在以太坊升级PoS后，用户通过质押以太币来激活和管理验证者。每一个验证者除了自身至少需要32个ETH，还需要配套专用计算机执行客户端和保证节点持续运行。而当超过32个ETH时，质押者可选择激活多个验证者身份，每有32个ETH被质押，就会激活一个验证者。

验证者通过验证者客户端来运行，同时需要与信标链保持配合。每一个信标节点都拥有追踪和读取信标链的功能。每一个验证者客户端也可以作为信标节点使用，并且与其他信标节点通信。一个验证者客户端可以同时包含多个验证者的职能。

质押方式上，节点和用户可以采取多种方式进行质押：单独质押（Solo home staking）、质押即服务（Staking as a service），池子质押（Pooled staking）亦或是中心化交易所质押（Centralized exchanges）。其具体实现方式本文不作详细阐述，有兴趣的读者可自行查阅。

**奖励与惩罚**

在 PoS 权益证明机制下的信标链中，验证者会通过以下途径获取奖励：

1、如果验证者投出了绝大多数其他验证者都同意的证明，那么它就会得到奖励。

2、当提议者提出的区块被最终确认时，提议者会得到奖励。

3、对恶意行为举报成功的验证者，将会得到举报者奖励。

而验证节点的不当行为也将会受到来自协议的惩罚，惩罚大致分为两种：惩罚（Penalties）和削减（Slashing）。

惩罚是由于验证节点一直不活动或者产生了不正确的证明而导致的处罚，但惩罚只会对验证节点的余额进行罚款并不会把该验证节点从协议中驱逐出去。

而削减则是更为严重的一种惩罚机制，只有危害以太坊网络整体稳定性的验证节点才会被进行削减处罚，该惩罚使得作恶节点可能面临的最高损失为其拥有的所有权益，同时该作恶节点还会被驱逐出协议。被削减的情况通常分为：

1、作为区块提议者，在其分配的插槽内提出两个相冲突的区块提案。  

2、作为节点验证者投票时，产生两票，其中包含对相同高度（height）的检查点区块过渡的冲突引用。即在一个插槽中为两个完全冲突的区块都进行了验证并投票，这被称为”双重投票“。  

3、作为验证投票者不按顺序进行”环绕投票“，即用重叠的检查点区块过渡引用产生两票。例如，引用从检查点区块 1 到检查点区块 4 的过渡的投票，和引用从检查点区块 2 到检查点区块 3 的过渡的投票。有人可能会认为此规则应该由更明显的规则取代，即所有区块过渡引用都应该按顺序进行，然而一个诚实节点可能会错过检查点区块，而不按顺序的投票可能是合法的。如下图：

![](/images/posts/blockchain/eth_upgrade_4.png)
图源自BitMEX

如果作恶节点被进行了削减处罚，该节点将立即受到惩罚并不再进行验证，并将继续受到持续约36天的惩罚，并在36天后的某个周期（Epoch）之后才可以退出，惩罚的金额视作恶的严重程度而定，最高罚可没所有权益。

**验证者生命周期**

每个验证者需要 32 ETH 的余额才能被激活。用户将32 ETH 质押到以太坊主网上的存款合约中，将激活一个验证器。信标链將停用（“强制退出”）所有余额只剩 16 ETH 的验证者；质押者将能够提取任何剩余的验证者余额。

下图是每个验证者的状态转移图：

![](/images/posts/blockchain/eth_upgrade_5.png)
图源自ethereum.org

1、存款

验证人已将ETH存入押金合约，并进行了相应的Deposit操作。

2、激活队列

在 epoch-processing 中，检查验证者是否有资格激活。

3、活跃状态

活跃的验证者将在每个epoch内被分配职责（执行证明、提议等）并获得奖励。

4、削减并退出

在提款之前，被削减退出的验证者将等待8192个epoch（约 36 天）的长期锁定期。

5、非削减退出

未削减退出的验证者需要等待256 个epoch（约27 小时）才能转变为可提款状态。

6、提款

可提现状态是本阶段的结束状态，验证者可以在后续阶段执行提现。

**委员会**

权益证明将以太坊的时间分为插槽（Slot）和周期（Epoch），这决定了系统中共识的节奏，即*每一隔 12 秒出一个插槽，每个周期包含 32 个插槽*，即每隔 6.4 分钟产生一个周期，每个插槽中只能创建一个有效区块，每个插槽中随机选择一个验证者作为区块提议者，该验证器负责创建一个新分片区块并将其发送到网络上的其他节点。

同样在每个插槽中，信标链会随机选择一个由*至少128个验证者组成的“委员会（committees）”*来对每一个分片区块进行投票，其投票用于确定所提议区块的有效性，委员会验证者的数量不是固定的且随着区块的变化而改变，每个周期过后，委员会都由不同的、随机的参与者解散与改革，这有助于避免委员会中的不良参与者伤害到分片。

委员会除了验证投票之外，还需要负责将自己所在插槽中的分片区块尝试交联（crosslinks）某个信标链上的特定区块。其中，交联是指将一个信标区块和其对应的所有分片区块通过生成引用连接起来，分片区块会接收来自对应信标区块的哈希值，该值包含所有与其交联的分片区块哈希值。

信标区块主要与上一区块对应的分片区块交联，但也可能与上上个区块对应的分片区块交联，这是因为某些信标区块可能丢失对部分分片区块的引用，而这些交联将使得被错过的分片区块可以交联到本次信标区块中

![](/images/posts/blockchain/eth_upgrade_6.png)
图源自BitMEX

下图是对三个插槽中可能发生的情况描述。

![](/images/posts/blockchain/eth_upgrade_7.png)
图源自BitMEX

第一种情况为在 Slot 1 中，提议者提出一个块，然后由两个验证者证明；A 委员会的一名验证人离线。Slot 1 的证明和区块传播网络并到达许多验证者。

第二种情况为在 Slot 2 中，提议者提出了一个块，但委员会 B 中的验证者没有看到它，因此它证明信标链头是 Slot 1 的块。

第三种情况为在 Slot 3 中，委员会 C 中的所有验证者都独立证明同一个头。

每个周期（epoch）中，一个验证者只能被包含在一个委员会中。目前以太坊有超过 8,192
名验证者，这意味着每个插槽不止一个委员会。所有委员会的规模相同，并且至少有 128 名验证者。当验证者少于 4,096 时，安全概率会降低。

### London升级：EIP-1559

EIP-1559提出了一种新的链上手续费定价机制：将原本的交易手续费由“拍卖式”定价改为“市场汇率”定价机制，具体地说就是将手续费拆分为基础费和优先费两部分，其中基础费由以太坊根据区块容量确定，优先费由用户根据其他费用市场决定。交易提交后，基础费会被销毁，而优先费会奖励给打包交易的矿工。

![](/images/posts/blockchain/eth_upgrade_8.png)
图源自BitMEX

**以太坊链上交易UX（User Experience）**

EIP-1559规定了以太坊的手续费中的基础费用，从而减少了手续费和交易时间的许多不确定性。且由于交易创建者可以根据交易的紧急性设置优先费，意味着交易打包主导权由矿工转向用户，网络拥堵问题将有望得到缓解。

**ETH经济机制**

该费用系统的一个重要方面是矿工只能保留优先费用，基本费用总是被烧掉（即被协议销毁）。EIP-1559要求所有基础费用都必须以ETH支付，这缓解了经济抽象化的风险，巩固了以太坊平台内 ETH 的经济价值，并降低了矿工可提取价值(MEV)相关的风险。随着以太坊的繁荣，基础费用造成的销毁量如果大于ETH的增发量，则将会使ETH从通货膨胀资产转变为供应逐步减少的通货紧缩资产。

**以太坊安全性**

EIP-1559有助于防止针对以太坊网络的垃圾交易攻击。在升级之前，理论上攻击者可以串通矿工，以低于市场价格的手续费向以太坊发送垃圾交易，造成网络拥堵。但是EIP-1559确保了攻击者永远无法以低于基础费用的手续费发起攻击。同时随着时间的推移，这种攻击甚至会变得更加昂贵，因为垃圾交易造成的网络拥堵，会使得以太坊不断提高基础费用。

### **“Merge”进展与难度炸弹**

按照计划，以太坊的 Merge 以“最小破坏”原则进行，使原来运行的应用客户端可以无感地切换到PoS。信标链先是作为PoW之上的中间层存在，类似第二层共识网络。待到 Merge 后，原来的主网变成“执行层”，智能合约、网络规则保留其中；而原来的信标链变成“共识层”，并将PoW层内的执行相关组件组合到新的共识层，PoW将不复存在。目前以太坊升级时间点如下图：

![](/images/posts/blockchain/eth_upgrade_9.png)
图源自ethereum.org

2022 年 3 月 15 日，以太坊合并公共测试网 Kiln 上线，代表它已经成功过渡、升级到完整的 PoS 机制。

2022 年 6 月 8 日，以太坊完成了 Merge 的第一次彩排——测试网 Ropsten 顺利完成了合并。Ropsten 于 2016 年推出，是迄今为止运行时间最长的以太坊测试网。据以太坊核心开发者消息，在Ropsten 的合并过程中约有 14% 的验证者出现停机状况，但大多是由于错误的节点配置所导致的，这些问题很快得到解决。此外，在 Ropsten 上的合并被认为近乎完美，并且成为以太坊向 PoS 迁移的重要里程碑。

2022 年 7 月 27 日，以太坊宣布 Bellatrix 升级为 Goerli 的信标链 Prater，为测试网合并做准备。

2022 年 8 月 4 日，Bellatrix 信标链激活，为合并前做最后的准备工作。

2022 年8 月 12 日1：45时，Georli 测试网与信标链完成合并，Georli 测试网正式过渡为 PoS 证明。而这也是以太坊在正式升级前的最后一个进行合并的测试网。

目前，据以太坊核心开发者电话会议内容显示，以太坊主网 Bellatrix 升级 Epoch 为 144896，预计时间为 9 月 6 日，主网 TTD（Terminal Total Difficulty）为 58750000000000000000000，预计时间为 9 月 15 日，届时将启动 Paris 升级，完成硬分叉。

而最近的一次难度炸弹（Difficulty Bomb）预计在9月13日降临。

![](/images/posts/blockchain/eth_upgrade_10.png)
源自wenmerge.com

难度炸弹主要是为了降低挖矿的盈利能力，以便在合并之前打击矿工的积极性。通过增加矿工验证交易的难度，从而降低PoW矿工的盈利能力。当难度达到极限时，物理矿工将无法验证区块。

其在2015年被加入到代码中，是一种根据区块时间调整链难度的机制算法。该算法实现主要通过人为地增加挖矿难度，实现让矿工丧失挖矿动力，从而转向升级后的 PoS 链的目的。其中，难度炸弹中的动态参数调整算法较为复杂，该算法会在每 10 万个区块后将难度值增大一倍，以不断增加的区块高度推动挖矿难度指数级增长，直至难度增大到一定程度后，使得矿工无法获得区块领取奖励。

![](/images/posts/blockchain/eth_upgrade_11.png)

目前由于以太坊合并的延期，使得开发者不断采取伪区块号代替原区块号的方式延迟爆发时间。但随着以太坊生态的发展，目前的体量使得拆除和延迟难度炸弹的可能性越来越小。

但是造成以太坊合并一次次的推迟的原因，本质上是如何在不分叉的前提下，说服整个生态的人（尤其是矿工）把自己手里大量的资源转向 PoS，这是一个极为棘手的难题。

## 逐渐淡化的ETH2.0说法

目前V神和社区都在逐渐淡化ETH2.0的说法，主要有以下几个原因：

1、  **ETH2.0 的一个主要问题是这为以太坊新用户创造了一种破碎的心理模型。** 他们会凭直觉认为ETH1.0 在前，ETH2.0
在后；或者ETH2.0 问世后，ETH1.0
就不复存在了。但这两种想法都不对，合并后现有的以太坊将作为执行层，负责处理事务和执行；信标链作为共识层融入原有以太坊，负责处理权益证明共识。

2、  **随着以太坊发展路线图的演变，以太坊 2.0 已无法准确代表以太坊目前的发展路线图。**
严谨准确的用词选择有助于让最广泛的受众了解以太坊上的内容。

3、  **预防诈骗。** 此前，已有攻击者试图利用“ETH2”这一虚假代币来欺骗用户，告诉他们用ETH兑换 “ETH2” 代币，或者要在ETH2.0
升级之前必须以某种方式迁移ETH。社区希望通过淡化ETH2.0来消除这种骗局，打造更安全的生态系统。

4、  **质押澄清。** 有些质押项目方还使用“ETH2”代表在信标链上质押的以太币。由于这些用户实际上并不会收到“ETH2”代币，因此可能会造成混乱。

---

> 参考文献：
>
> [以太坊升级](https://ethereum.org/en/upgrades/)
>
> [Two Point Oh: The Beacon Chain](https://our.status.im/two-point-oh-the-beacon-chain/)
>
> [以太坊2.0](https://blog.bitmex.com/zh_cn-ethereum-2-0/)
>
> [The Beacon Chain Ethereum 2.0 explainer you need to read first](https://ethos.dev/beacon-chain/)
>
> [以太坊的权益证明系统 － 计算惩罚和奖励](https://blog.bitmex.com/zh_cn-ethereums-proof-of-stake-system-calculating-penalties-rewards/)
>
> [历史重演？详解以太坊2.0与硬分叉](https://www.theblockbeats.info/news/31549)
>
> [以太坊合并的理想与现实](https://web3caff.com/zh/archives/22657)
>
> [费用市场解读 (EIP-1559)](https://blog.bitmex.com/zh_cn-breaking-down-the-fee-market-eip-1559/)
